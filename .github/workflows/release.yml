name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build universal installer
    runs-on: macos-15
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # macos-15 runner ships Xcode 16.x which has the macOS 15 SDK.
      # macOS 15 SDK still supports x86_64, enabling universal (Intel + Apple Silicon) builds.
      - name: Select Xcode 16
        run: |
          XCODE=$(ls /Applications/ | grep "^Xcode_16" | sort -V | tail -1)
          if [ -n "$XCODE" ]; then
            sudo xcode-select -s "/Applications/$XCODE/Contents/Developer"
          fi
          xcodebuild -version

      - name: Install battery CLI
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ github.token }}
        run: |
          brew install actuallymentor/battery/battery
          # Copy to resources/ so create_installer.sh finds it
          mkdir -p resources
          cp "$(brew --prefix)/bin/battery" resources/battery
          chmod +x resources/battery

      - name: Build universal binary
        run: |
          xcodebuild \
            -project BatterySmartCharge.xcodeproj \
            -scheme BatterySmartCharge \
            -configuration Release \
            ARCHS="arm64 x86_64" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            clean build

      - name: Verify architectures
        run: |
          APP_BIN=$(find ~/Library/Developer/Xcode/DerivedData \
            -name "BatterySmartCharge" -type f \
            -path "*/Release/BatterySmartCharge.app/Contents/MacOS/*" | head -1)
          echo "App binary architectures: $(lipo -archs "$APP_BIN")"

      - name: Create installer package
        run: ./create_installer.sh

      - name: Upload installer to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/BatterySmartCharge-*.pkg
          fail_on_unmatched_files: true
